---
- name: gather os specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution|lower }}-{{ ansible_distribution_version|lower|replace('/', '_') }}.yml"
        - "{{ ansible_distribution|lower }}-{{ ansible_distribution_release }}.yml"
        - "{{ ansible_distribution|lower }}-{{ ansible_distribution_major_version|lower|replace('/', '_') }}.yml"
        - "{{ ansible_distribution|lower }}.yml"
        - "{{ ansible_os_family|lower }}-{{ ansible_architecture }}.yml"
        - "{{ ansible_os_family|lower }}.yml"
        - defaults.yml
      paths:
        - ../vars
      skip: true
  tags:
    - facts

- name: Add Disco Ubuntu repository for Containerd
  apt_repository:
    filename: disco
    repo: "deb http://ports.ubuntu.com/ubuntu-ports disco universe"
    state: present
  when: ansible_distribution == "Ubuntu" and not is_atomic

- name: Copy disco.pref with pinning for containerd and runc
  copy:
    src: disco.pref
    dest: /etc/apt/preferences.d/disco.pref
  when: ansible_distribution == "Ubuntu" and not is_atomic

- name: Install containerd packages
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ containerd_packages }}"

- name: Install containerd service
  service:
    name: "{{ containerd_service }}"
    enabled: yes
    state: restarted
